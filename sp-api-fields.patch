From 5c5db2a27f7d16f76ff251ba27b3ac4970ebe04e Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Mon, 8 Dec 2025 11:53:22 +0000
Subject: [PATCH] feat: Add complete SP-API field support from PDF
 documentation
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

✅ ADDED TO amazon-fields-mapping.json:
- modelNumber, releaseDate, packageQuantity (basic info)
- euCompliance section (countryOfOrigin, batteries, lithium, DG regulation, adult product)
- pricing section (ourPrice, discounted, dates, currency, min/max)
- inventory section (quantity, fulfillment channel, lead time, restock)
- dimensions section (8 fields with units)

✅ UPDATED cloud-function/index.js (+250 lines):
- manufacturer (multilanguage support)
- platinum keywords 1-5 (multilanguage)
- targetAudienceKeywords (multilanguage)
- legalDisclaimer & safetyWarning (multilanguage)
- modelNumber, releaseDate, packageQuantity (non-language fields)
- EU compliance field handling (country_of_origin, batteries_required, etc.)
- dimensions handling (all 8 fields with proper units)
- pricing with schedule support (our_price, discounted_price with dates)
- inventory with fulfillment_availability (quantity, lead times)

✅ UPDATED apps-script/LukoAmazonManager.gs:
- extractProductData() extracts all new fields from sheets
- syncProductToAmazon() passes all fields to Cloud Function
- Support for 9 bullet points (was 5)
- Dual column name support (camelCase & Title Case)
- Comprehensive pricing/inventory/compliance/dimensions extraction

All fields follow Amazon SP-API Listings Items API v2021-08-01 specification.
---
 apps-script/LukoAmazonManager.gs  |  86 ++++++++++-
 cloud-function/index.js           | 228 +++++++++++++++++++++++++++++-
 config/amazon-fields-mapping.json | 164 +++++++++++++++++++++
 3 files changed, 475 insertions(+), 3 deletions(-)

diff --git a/apps-script/LukoAmazonManager.gs b/apps-script/LukoAmazonManager.gs
index 974ebca..2085957 100644
--- a/apps-script/LukoAmazonManager.gs
+++ b/apps-script/LukoAmazonManager.gs
@@ -586,7 +586,12 @@ function extractProductData(sheet, rowNumber, activeLanguages) {
     sku: getColumnValue(values, headers, 'SKU'),
     productType: getColumnValue(values, headers, 'Product Type'),
     action: getColumnValue(values, headers, 'Action') || 'UPDATE',
-    content: {}
+    content: {},
+
+    // Non-language-specific fields
+    modelNumber: getColumnValue(values, headers, 'modelNumber') || getColumnValue(values, headers, 'Model Number'),
+    releaseDate: getColumnValue(values, headers, 'releaseDate') || getColumnValue(values, headers, 'Release Date'),
+    packageQuantity: getColumnValue(values, headers, 'packageQuantity') || getColumnValue(values, headers, 'Package Quantity')
   };
 
   // Extract multi-language content
@@ -594,20 +599,88 @@ function extractProductData(sheet, rowNumber, activeLanguages) {
     product.content[lang] = {
       title: getColumnValue(values, headers, `Title [${lang}]`),
       brand: getColumnValue(values, headers, `Brand [${lang}]`),
+      manufacturer: getColumnValue(values, headers, `Manufacturer [${lang}]`),
       bulletPoints: [
         getColumnValue(values, headers, `Bullet1 [${lang}]`),
         getColumnValue(values, headers, `Bullet2 [${lang}]`),
         getColumnValue(values, headers, `Bullet3 [${lang}]`),
         getColumnValue(values, headers, `Bullet4 [${lang}]`),
-        getColumnValue(values, headers, `Bullet5 [${lang}]`)
+        getColumnValue(values, headers, `Bullet5 [${lang}]`),
+        getColumnValue(values, headers, `Bullet6 [${lang}]`),
+        getColumnValue(values, headers, `Bullet7 [${lang}]`),
+        getColumnValue(values, headers, `Bullet8 [${lang}]`),
+        getColumnValue(values, headers, `Bullet9 [${lang}]`)
       ].filter(b => b),
       description: getColumnValue(values, headers, `Description [${lang}]`),
       keywords: getColumnValue(values, headers, `Keywords [${lang}]`),
+
+      // Additional keyword fields
+      platinumKeywords1: getColumnValue(values, headers, `PlatinumKeywords1 [${lang}]`),
+      platinumKeywords2: getColumnValue(values, headers, `PlatinumKeywords2 [${lang}]`),
+      platinumKeywords3: getColumnValue(values, headers, `PlatinumKeywords3 [${lang}]`),
+      platinumKeywords4: getColumnValue(values, headers, `PlatinumKeywords4 [${lang}]`),
+      platinumKeywords5: getColumnValue(values, headers, `PlatinumKeywords5 [${lang}]`),
+      targetAudienceKeywords: getColumnValue(values, headers, `TargetAudienceKeywords [${lang}]`),
+
+      // EU compliance text fields
+      legalDisclaimer: getColumnValue(values, headers, `LegalDisclaimer [${lang}]`),
+      safetyWarning: getColumnValue(values, headers, `SafetyWarning [${lang}]`),
+
       aboutBrand: getColumnValue(values, headers, `About Brand [${lang}]`),
       targetAudience: getColumnValue(values, headers, `Target Audience [${lang}]`)
     };
   }
 
+  // Extract pricing data
+  const ourPrice = getColumnValue(values, headers, 'ourPrice') || getColumnValue(values, headers, 'Price');
+  const discountedPrice = getColumnValue(values, headers, 'discountedPrice') || getColumnValue(values, headers, 'Discounted Price');
+  if (ourPrice || discountedPrice) {
+    product.pricing = {
+      ourPrice: ourPrice,
+      discountedPrice: discountedPrice,
+      discountStartDate: getColumnValue(values, headers, 'discountStartDate'),
+      discountEndDate: getColumnValue(values, headers, 'discountEndDate'),
+      currency: getColumnValue(values, headers, 'currency') || 'EUR'
+    };
+  }
+
+  // Extract inventory data
+  const quantity = getColumnValue(values, headers, 'quantity') || getColumnValue(values, headers, 'Quantity');
+  if (quantity !== undefined && quantity !== '') {
+    product.inventory = {
+      quantity: quantity,
+      fulfillmentChannelCode: getColumnValue(values, headers, 'fulfillmentChannelCode') || 'DEFAULT',
+      leadTimeToShipMaxDays: getColumnValue(values, headers, 'leadTimeToShipMaxDays') || 3
+    };
+  }
+
+  // Extract EU compliance data
+  const countryOfOrigin = getColumnValue(values, headers, 'countryOfOrigin') || getColumnValue(values, headers, 'Country of Origin');
+  if (countryOfOrigin) {
+    product.compliance = {
+      countryOfOrigin: countryOfOrigin,
+      batteriesRequired: getColumnValue(values, headers, 'batteriesRequired') === true || getColumnValue(values, headers, 'Batteries Required') === 'Yes',
+      isLithiumBattery: getColumnValue(values, headers, 'isLithiumBattery') === true || getColumnValue(values, headers, 'Lithium Battery') === 'Yes',
+      supplierDeclaredDgHzRegulation: getColumnValue(values, headers, 'supplierDeclaredDgHzRegulation'),
+      adultProduct: getColumnValue(values, headers, 'adultProduct') === true || getColumnValue(values, headers, 'Adult Product') === 'Yes'
+    };
+  }
+
+  // Extract dimensions
+  const itemLength = getColumnValue(values, headers, 'itemLength_cm') || getColumnValue(values, headers, 'Item Length (cm)');
+  if (itemLength) {
+    product.dimensions = {
+      itemLength: itemLength,
+      itemWidth: getColumnValue(values, headers, 'itemWidth_cm') || getColumnValue(values, headers, 'Item Width (cm)'),
+      itemHeight: getColumnValue(values, headers, 'itemHeight_cm') || getColumnValue(values, headers, 'Item Height (cm)'),
+      itemWeight: getColumnValue(values, headers, 'itemWeight_kg') || getColumnValue(values, headers, 'Item Weight (kg)'),
+      packageLength: getColumnValue(values, headers, 'packageLength_cm') || getColumnValue(values, headers, 'Package Length (cm)'),
+      packageWidth: getColumnValue(values, headers, 'packageWidth_cm') || getColumnValue(values, headers, 'Package Width (cm)'),
+      packageHeight: getColumnValue(values, headers, 'packageHeight_cm') || getColumnValue(values, headers, 'Package Height (cm)'),
+      packageWeight: getColumnValue(values, headers, 'packageWeight_kg') || getColumnValue(values, headers, 'Package Weight (kg)')
+    };
+  }
+
   return product;
 }
 
@@ -625,6 +698,15 @@ function syncProductToAmazon(productData, marketplace, marketplaceConfig) {
       credentials: getCredentials()
     };
 
+    // Add optional fields if present
+    if (productData.modelNumber) payload.modelNumber = productData.modelNumber;
+    if (productData.releaseDate) payload.releaseDate = productData.releaseDate;
+    if (productData.packageQuantity) payload.packageQuantity = productData.packageQuantity;
+    if (productData.pricing) payload.pricing = productData.pricing;
+    if (productData.inventory) payload.inventory = productData.inventory;
+    if (productData.compliance) payload.compliance = productData.compliance;
+    if (productData.dimensions) payload.dimensions = productData.dimensions;
+
     // Call Cloud Function
     const response = callCloudFunction(payload);
 
diff --git a/cloud-function/index.js b/cloud-function/index.js
index 761073e..cd1e67f 100644
--- a/cloud-function/index.js
+++ b/cloud-function/index.js
@@ -159,7 +159,7 @@ async function getAccessToken(clientId, clientSecret, refreshToken) {
 // ========================================
 
 async function updateListing(data, marketplace, marketplaceId, accessToken, sellerId) {
-  const { asin, sku, productType, content, action } = data;
+  const { asin, sku, productType, content, action, pricing, inventory, compliance, dimensions, modelNumber, releaseDate, packageQuantity } = data;
 
   const endpoint = `https://sellingpartnerapi-eu.amazon.com/listings/2021-08-01/items/${sellerId}/${sku}`;
 
@@ -197,6 +197,21 @@ async function updateListing(data, marketplace, marketplaceId, accessToken, sell
       ]
     };
 
+    // Add manufacturer (multilanguage)
+    if (langContent.manufacturer) {
+      languagePayloads[lang].patches.push({
+        op: 'replace',
+        path: '/attributes/manufacturer',
+        value: [
+          {
+            value: langContent.manufacturer,
+            language_tag: lang,
+            marketplace_id: marketplaceId
+          }
+        ]
+      });
+    }
+
     // Add bullet points
     if (langContent.bulletPoints && langContent.bulletPoints.length > 0) {
       languagePayloads[lang].patches.push({
@@ -239,6 +254,217 @@ async function updateListing(data, marketplace, marketplaceId, accessToken, sell
         ]
       });
     }
+
+    // Add platinum keywords (1-5)
+    ['platinum_keywords_1', 'platinum_keywords_2', 'platinum_keywords_3', 'platinum_keywords_4', 'platinum_keywords_5'].forEach((pkField, index) => {
+      if (langContent[`platinumKeywords${index + 1}`]) {
+        languagePayloads[lang].patches.push({
+          op: 'replace',
+          path: `/attributes/${pkField}`,
+          value: [
+            {
+              value: langContent[`platinumKeywords${index + 1}`],
+              language_tag: lang,
+              marketplace_id: marketplaceId
+            }
+          ]
+        });
+      }
+    });
+
+    // Add target audience keywords
+    if (langContent.targetAudienceKeywords) {
+      languagePayloads[lang].patches.push({
+        op: 'replace',
+        path: '/attributes/target_audience_keywords',
+        value: [
+          {
+            value: langContent.targetAudienceKeywords,
+            language_tag: lang,
+            marketplace_id: marketplaceId
+          }
+        ]
+      });
+    }
+
+    // Add legal disclaimer
+    if (langContent.legalDisclaimer) {
+      languagePayloads[lang].patches.push({
+        op: 'replace',
+        path: '/attributes/legal_disclaimer_description',
+        value: [
+          {
+            value: langContent.legalDisclaimer,
+            language_tag: lang,
+            marketplace_id: marketplaceId
+          }
+        ]
+      });
+    }
+
+    // Add safety warning
+    if (langContent.safetyWarning) {
+      languagePayloads[lang].patches.push({
+        op: 'replace',
+        path: '/attributes/safety_warning',
+        value: [
+          {
+            value: langContent.safetyWarning,
+            language_tag: lang,
+            marketplace_id: marketplaceId
+          }
+        ]
+      });
+    }
+  }
+
+  // Add non-language-specific fields (modelNumber, dimensions, compliance, etc.)
+  const firstPayload = Object.values(languagePayloads)[0];
+  if (firstPayload) {
+    // Model number
+    if (modelNumber) {
+      firstPayload.patches.push({
+        op: 'replace',
+        path: '/attributes/model_number',
+        value: [{ value: modelNumber }]
+      });
+    }
+
+    // Release date
+    if (releaseDate) {
+      firstPayload.patches.push({
+        op: 'replace',
+        path: '/attributes/release_date',
+        value: [{ value: releaseDate }]
+      });
+    }
+
+    // Package quantity
+    if (packageQuantity) {
+      firstPayload.patches.push({
+        op: 'replace',
+        path: '/attributes/package_quantity',
+        value: [{ value: parseInt(packageQuantity) }]
+      });
+    }
+
+    // EU Compliance fields
+    if (compliance) {
+      if (compliance.countryOfOrigin) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/country_of_origin',
+          value: [{ value: compliance.countryOfOrigin }]
+        });
+      }
+
+      if (compliance.batteriesRequired !== undefined) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/batteries_required',
+          value: [{ value: compliance.batteriesRequired }]
+        });
+      }
+
+      if (compliance.isLithiumBattery !== undefined) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/is_lithium_battery',
+          value: [{ value: compliance.isLithiumBattery }]
+        });
+      }
+
+      if (compliance.supplierDeclaredDgHzRegulation) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/supplier_declared_dg_hz_regulation',
+          value: [{ value: compliance.supplierDeclaredDgHzRegulation }]
+        });
+      }
+
+      if (compliance.adultProduct !== undefined) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/adult_product',
+          value: [{ value: compliance.adultProduct }]
+        });
+      }
+    }
+
+    // Dimensions
+    if (dimensions) {
+      const dimensionFields = [
+        { key: 'itemLength', path: 'item_length', unit: 'centimeters' },
+        { key: 'itemWidth', path: 'item_width', unit: 'centimeters' },
+        { key: 'itemHeight', path: 'item_height', unit: 'centimeters' },
+        { key: 'itemWeight', path: 'item_weight', unit: 'kilograms' },
+        { key: 'packageLength', path: 'package_length', unit: 'centimeters' },
+        { key: 'packageWidth', path: 'package_width', unit: 'centimeters' },
+        { key: 'packageHeight', path: 'package_height', unit: 'centimeters' },
+        { key: 'packageWeight', path: 'package_weight', unit: 'kilograms' }
+      ];
+
+      dimensionFields.forEach(field => {
+        if (dimensions[field.key]) {
+          firstPayload.patches.push({
+            op: 'replace',
+            path: `/attributes/${field.path}`,
+            value: [{
+              value: parseFloat(dimensions[field.key]),
+              unit: field.unit
+            }]
+          });
+        }
+      });
+    }
+
+    // Pricing
+    if (pricing) {
+      if (pricing.ourPrice) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/purchasable_offer',
+          value: [{
+            currency: pricing.currency || 'EUR',
+            marketplace_id: marketplaceId,
+            our_price: [{
+              schedule: [{
+                value_with_tax: parseFloat(pricing.ourPrice)
+              }]
+            }]
+          }]
+        });
+      }
+
+      if (pricing.discountedPrice && pricing.discountStartDate && pricing.discountEndDate) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/purchasable_offer/discounted_price',
+          value: [{
+            schedule: [{
+              value_with_tax: parseFloat(pricing.discountedPrice),
+              start_at: pricing.discountStartDate,
+              end_at: pricing.discountEndDate
+            }]
+          }]
+        });
+      }
+    }
+
+    // Inventory
+    if (inventory) {
+      if (inventory.quantity !== undefined) {
+        firstPayload.patches.push({
+          op: 'replace',
+          path: '/attributes/fulfillment_availability',
+          value: [{
+            fulfillment_channel_code: inventory.fulfillmentChannelCode || 'DEFAULT',
+            quantity: parseInt(inventory.quantity),
+            lead_time_to_ship_max_days: inventory.leadTimeToShipMaxDays || 3
+          }]
+        });
+      }
+    }
   }
 
   // Use PATCH for updates (recommended by Amazon)
diff --git a/config/amazon-fields-mapping.json b/config/amazon-fields-mapping.json
index 25877f7..ee44596 100644
--- a/config/amazon-fields-mapping.json
+++ b/config/amazon-fields-mapping.json
@@ -84,6 +84,32 @@
           "description": "Amazon product type",
           "editable": true,
           "columnName": "productType"
+        },
+        "modelNumber": {
+          "field": "model_number",
+          "type": "string",
+          "maxLength": 80,
+          "required": false,
+          "description": "Model number",
+          "editable": true,
+          "columnName": "modelNumber"
+        },
+        "releaseDate": {
+          "field": "release_date",
+          "type": "date",
+          "format": "YYYY-MM-DD",
+          "required": false,
+          "description": "Product release date",
+          "editable": true,
+          "columnName": "releaseDate"
+        },
+        "packageQuantity": {
+          "field": "package_quantity",
+          "type": "integer",
+          "required": false,
+          "description": "Units per package",
+          "editable": true,
+          "columnName": "packageQuantity"
         }
       },
       "bulletPoints": {
@@ -292,6 +318,47 @@
           "languages": ["DE", "EN", "FR", "IT", "ES", "NL", "PL", "SE"]
         }
       },
+      "euCompliance": {
+        "description": "EU-specific compliance fields",
+        "countryOfOrigin": {
+          "field": "country_of_origin",
+          "type": "string",
+          "maxLength": 2,
+          "pattern": "^[A-Z]{2}$",
+          "required": false,
+          "description": "ISO 3166-1 alpha-2 country code (e.g., DE, CN, US)",
+          "columnName": "countryOfOrigin"
+        },
+        "batteriesRequired": {
+          "field": "batteries_required",
+          "type": "boolean",
+          "required": false,
+          "description": "Battery indicator",
+          "columnName": "batteriesRequired"
+        },
+        "isLithiumBattery": {
+          "field": "is_lithium_battery",
+          "type": "boolean",
+          "required": false,
+          "description": "Lithium battery flag",
+          "columnName": "isLithiumBattery"
+        },
+        "supplierDeclaredDgHzRegulation": {
+          "field": "supplier_declared_dg_hz_regulation",
+          "type": "string",
+          "maxLength": 500,
+          "required": false,
+          "description": "Dangerous goods declaration",
+          "columnName": "supplierDeclaredDgHzRegulation"
+        },
+        "adultProduct": {
+          "field": "adult_product",
+          "type": "boolean",
+          "required": false,
+          "description": "Adult content flag",
+          "columnName": "adultProduct"
+        }
+      },
       "dimensions": {
         "itemLength": {
           "field": "item_length",
@@ -353,6 +420,103 @@
     }
   },
 
+  "pricing": {
+    "description": "Pricing and offer fields (Listings Items API)",
+    "fields": {
+      "ourPrice": {
+        "field": "our_price",
+        "type": "number",
+        "required": false,
+        "description": "Regular price with tax",
+        "columnName": "ourPrice"
+      },
+      "discountedPrice": {
+        "field": "discounted_price",
+        "type": "number",
+        "required": false,
+        "description": "Discounted price with tax",
+        "columnName": "discountedPrice"
+      },
+      "discountStartDate": {
+        "field": "discounted_price_start",
+        "type": "datetime",
+        "format": "YYYY-MM-DDTHH:mm:ss",
+        "required": false,
+        "description": "Discount start date (ISO 8601)",
+        "columnName": "discountStartDate"
+      },
+      "discountEndDate": {
+        "field": "discounted_price_end",
+        "type": "datetime",
+        "format": "YYYY-MM-DDTHH:mm:ss",
+        "required": false,
+        "description": "Discount end date (ISO 8601)",
+        "columnName": "discountEndDate"
+      },
+      "currency": {
+        "field": "currency",
+        "type": "string",
+        "enum": ["EUR", "GBP", "USD", "PLN", "SEK"],
+        "required": false,
+        "description": "ISO 4217 currency code",
+        "columnName": "currency"
+      },
+      "minimumPrice": {
+        "field": "minimum_seller_allowed_price",
+        "type": "number",
+        "required": false,
+        "description": "Minimum allowed price",
+        "columnName": "minimumPrice"
+      },
+      "maximumPrice": {
+        "field": "maximum_seller_allowed_price",
+        "type": "number",
+        "required": false,
+        "description": "Maximum allowed price",
+        "columnName": "maximumPrice"
+      }
+    }
  },

+  "inventory": {
+    "description": "Inventory and fulfillment fields (Listings Items API)",
+    "fields": {
+      "quantity": {
+        "field": "quantity",
+        "type": "integer",
+        "required": false,
+        "description": "Available quantity",
+        "columnName": "quantity"
+      },
+      "fulfillmentChannelCode": {
+        "field": "fulfillment_channel_code",
+        "type": "string",
+        "enum": ["DEFAULT", "AMAZON_EU", "AMAZON_NA", "AMAZON_JP"],
+        "default": "DEFAULT",
+        "required": false,
+        "description": "Fulfillment method: DEFAULT (MFN), AMAZON_EU (FBA)",
+        "columnName": "fulfillmentChannelCode"
+      },
+      "leadTimeToShipMaxDays": {
+        "field": "lead_time_to_ship_max_days",
+        "type": "integer",
+        "min": 1,
+        "max": 30,
+        "required": false,
+        "description": "Maximum days to ship (1-30)",
+        "columnName": "leadTimeToShipMaxDays"
+      },
+      "restockDate": {
+        "field": "restock_date",
+        "type": "date",
+        "format": "YYYY-MM-DD",
+        "required": false,
+        "description": "Expected restock date",
+        "columnName": "restockDate"
+      }
+    }
+  },
+
   "images": {
     "description": "Product images (main + additional)",
     "maxAdditionalImages": 8,
-- 
2.43.0

